<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kasir PPOB BUMDes - RawBT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --secondary: #27ae60; --danger: #e74c3c; --accent: #2980b9; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 80px; background: var(--bg); color: #333; }
        
        /* Header Profil */
        .header { background: var(--primary); color: white; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header h2 { margin: 0; font-size: 1.2em; }
        .header p { margin: 5px 0 0; font-size: 0.8em; opacity: 0.8; }

        .container { padding: 15px; max-width: 800px; margin: auto; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        /* Form Styling */
        .form-group { margin-bottom: 12px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9em; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        
        /* Tombol */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; font-size: 1em; transition: 0.3s; margin-bottom: 5px; }
        .btn-save { background: var(--secondary); }
        .btn-reset { background: var(--danger); margin-top: 10px; }
        .btn-export { background: #f39c12; }
        .btn-print { background: var(--accent); }

        /* Navigasi Bawah */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); border-top: 1px solid #eee; z-index: 1000; }
        .nav-item { background: none; border: none; color: #7f8c8d; cursor: pointer; font-size: 0.75em; display: flex; flex-direction: column; align-items: center; gap: 4px; width: 25%; }
        .nav-item.active { color: var(--secondary); }
        .nav-item span { font-size: 1.5em; }

        /* Tabel Styling */
        .table-container { overflow-x: auto; background: white; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 500px; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; font-size: 0.85em; }
        th { background: #f8f9fa; font-weight: bold; }
        .tfoot-bold { font-weight: bold; background: #f8f9fa; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="header">
    <h2 id="dispNamaBumdes">BUMDes PPOB</h2>
    <p id="dispAlamatBumdes">Alamat belum diatur</p>
</div>

<div class="container">
    
    <div id="section-transaksi" class="content-section">
        <h3 style="margin-top:0">Entri Transaksi</h3>
        <div class="card">
            <div class="form-group">
                <label>Layanan PPOB</label>
                <select id="jenisPPOB" onchange="updateLabelID()">
                    <option value="Pulsa/Data">Pulsa / Paket Data</option>
                    <option value="PLN Token">PLN (Token Listrik)</option>
                    <option value="PLN Pascabayar">PLN (Tagihan Bulanan)</option>
                    <option value="PDAM">PDAM / Air</option>
                    <option value="Transfer">Transfer Bank</option>
                    <option value="Topup">E-Wallet (Dana/Ovo/Gopay)</option>
                </select>
            </div>
            <div class="form-group">
                <label id="labelID">Nomor Tujuan</label>
                <input type="text" id="nomorTujuan" placeholder="Masukkan nomor...">
            </div>
            <div class="form-group">
                <label>Nominal (Rp)</label>
                <input type="number" id="nominal" placeholder="0">
            </div>
            <div class="form-group">
                <label>Biaya Admin (Rp)</label>
                <input type="number" id="biayaAdmin" value="2500">
            </div>
            <div class="form-group">
                <label>Total Bayar</label>
                <input type="text" id="totalBayar" readonly style="background: #f0f0f0; font-weight: bold; color: var(--secondary);">
            </div>
            <button class="btn btn-save" onclick="simpanTransaksi()">SIMPAN & CETAK STRUK</button>
        </div>
    </div>

    <div id="section-riwayat" class="content-section hidden">
        <h3 style="margin-top:0">Riwayat Transaksi</h3>
        <button class="btn btn-export" onclick="exportToExcel()">Export Excel (.xlsx)</button>
        <div class="card table-container">
            <table id="tabelRiwayat">
                <thead>
                    <tr>
                        <th>Waktu</th>
                        <th>Layanan</th>
                        <th>Tujuan</th>
                        <th>Nominal</th>
                        <th>Admin</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="bodyRiwayat"></tbody>
            </table>
        </div>
    </div>

    <div id="section-laporan" class="content-section hidden">
        <h3 style="margin-top:0">Laporan Keuangan</h3>
        <button class="btn btn-print" onclick="cetakLaporanRawBT()">PRINT LAPORAN (RAWBT)</button>
        <div class="card table-container">
            <table id="tabelLaporan">
                <thead>
                    <tr>
                        <th>Kategori / Keterangan</th>
                        <th>Nilai (Rp)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Total Omset (Gross)</td>
                        <td id="lapOmset" style="text-align:right">0</td>
                    </tr>
                    <tr>
                        <td>Total Laba Admin (Net)</td>
                        <td id="lapAdmin" style="text-align:right">0</td>
                    </tr>
                    <tr>
                        <td>Jumlah Transaksi</td>
                        <td id="lapCount" style="text-align:right">0</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="section-setting" class="content-section hidden">
        <h3 style="margin-top:0">Pengaturan</h3>
        <div class="card">
            <label>Nama BUMDes</label>
            <input type="text" id="cfgNama" style="margin-bottom:10px">
            <label>Alamat & Kontak</label>
            <input type="text" id="cfgAlamat" style="margin-bottom:15px">
            <button class="btn btn-save" onclick="saveSettings()">Update Profil</button>
        </div>
        
        <div class="card">
            <input type="file" id="importExcel" style="display:none" onchange="importFromExcel(event)">
            <button class="btn btn-print" onclick="document.getElementById('importExcel').click()">Import File Excel</button>
            <button class="btn btn-reset" onclick="resetData()">Reset Semua Data</button>
        </div>
    </div>

</div>

<nav class="bottom-nav">
    <button class="nav-item active" onclick="showSection('section-transaksi', this)">
        <span>ðŸ“</span>Transaksi
    </button>
    <button class="nav-item" onclick="showSection('section-riwayat', this)">
        <span>ðŸ“œ</span>Riwayat
    </button>
    <button class="nav-item" onclick="showSection('section-laporan', this)">
        <span>ðŸ“Š</span>Laporan
    </button>
    <button class="nav-item" onclick="showSection('section-setting', this)">
        <span>âš™ï¸</span>Setting
    </button>
</nav>

<script>
    let dbTransaksi = JSON.parse(localStorage.getItem('ppob_data')) || [];
    let config = JSON.parse(localStorage.getItem('ppob_config')) || {
        nama: "BUMDes Campurejo Sukses Mandiri",
        alamat: "Jl. Raya Campurejo No. 123"
    };

    // Auto-calculate Total
    const nomInput = document.getElementById('nominal');
    const admInput = document.getElementById('biayaAdmin');
    [nomInput, admInput].forEach(el => el.addEventListener('input', () => {
        const total = (parseFloat(nomInput.value) || 0) + (parseFloat(admInput.value) || 0);
        document.getElementById('totalBayar').value = "Rp " + total.toLocaleString('id-ID');
    }));

    function showSection(id, btn) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if(id === 'section-riwayat') renderRiwayat();
        if(id === 'section-laporan') renderLaporan();
    }

    function updateLabelID() {
        const jenis = document.getElementById('jenisPPOB').value;
        const label = document.getElementById('labelID');
        if(jenis.includes("PLN")) label.innerText = "ID Pelanggan / Meter";
        else if(jenis.includes("Bank")) label.innerText = "Nomor Rekening";
        else label.innerText = "Nomor HP / ID Tujuan";
    }

    function simpanTransaksi() {
        const nom = parseFloat(document.getElementById('nominal').value) || 0;
        const adm = parseFloat(document.getElementById('biayaAdmin').value) || 0;
        
        const data = {
            waktu: new Date().toLocaleString('id-ID'),
            layanan: document.getElementById('jenisPPOB').value,
            tujuan: document.getElementById('nomorTujuan').value,
            nominal: nom,
            admin: adm,
            total: nom + adm
        };

        if(!data.tujuan || nom <= 0) return alert("Lengkapi data transaksi!");

        dbTransaksi.push(data);
        localStorage.setItem('ppob_data', JSON.stringify(dbTransaksi));
        
        cetakStrukRawBT(data);
        
        document.getElementById('nomorTujuan').value = "";
        document.getElementById('nominal').value = "";
        alert("Transaksi Berhasil!");
    }

    function renderRiwayat() {
        const body = document.getElementById('bodyRiwayat');
        body.innerHTML = dbTransaksi.map(t => `
            <tr>
                <td>${t.waktu}</td>
                <td>${t.layanan}</td>
                <td>${t.tujuan}</td>
                <td>${t.nominal.toLocaleString('id-ID')}</td>
                <td>${t.admin.toLocaleString('id-ID')}</td>
                <td><b>${t.total.toLocaleString('id-ID')}</b></td>
            </tr>
        `).reverse().join('');
    }

    function renderLaporan() {
        const omset = dbTransaksi.reduce((a, b) => a + b.total, 0);
        const laba = dbTransaksi.reduce((a, b) => a + b.admin, 0);
        document.getElementById('lapOmset').innerText = omset.toLocaleString('id-ID');
        document.getElementById('lapAdmin').innerText = laba.toLocaleString('id-ID');
        document.getElementById('lapCount').innerText = dbTransaksi.length;
    }

    // FUNGSI CETAK RAWBT STRUK
    function cetakStrukRawBT(t) {
        const txt = 
            `${config.nama}\n` +
            `${config.alamat}\n` +
            `--------------------------------\n` +
            `Waktu  : ${t.waktu}\n` +
            `Layanan: ${t.layanan}\n` +
            `Tujuan : ${t.tujuan}\n` +
            `--------------------------------\n` +
            `Nominal: Rp ${t.nominal.toLocaleString('id-ID')}\n` +
            `Admin  : Rp ${t.admin.toLocaleString('id-ID')}\n` +
            `--------------------------------\n` +
            `TOTAL  : Rp ${t.total.toLocaleString('id-ID')}\n` +
            `--------------------------------\n` +
            `    Terima Kasih - BUMDes\n\n\n`;
        window.location.href = "rawbt:base64," + btoa(txt);
    }

    // FUNGSI CETAK RAWBT LAPORAN
    function cetakLaporanRawBT() {
        const omset = dbTransaksi.reduce((a, b) => a + b.total, 0);
        const laba = dbTransaksi.reduce((a, b) => a + b.admin, 0);
        const txt = 
            `LAPORAN KEUANGAN PPOB\n` +
            `${config.nama}\n` +
            `Tanggal: ${new Date().toLocaleDateString('id-ID')}\n` +
            `--------------------------------\n` +
            `Total Transaksi : ${dbTransaksi.length}\n` +
            `Total Omset     : Rp ${omset.toLocaleString('id-ID')}\n` +
            `Total Laba Admin: Rp ${laba.toLocaleString('id-ID')}\n` +
            `--------------------------------\n` +
            `Printed at: ${new Date().toLocaleTimeString()}\n\n\n`;
        window.location.href = "rawbt:base64," + btoa(txt);
    }

    function saveSettings() {
        config.nama = document.getElementById('cfgNama').value;
        config.alamat = document.getElementById('cfgAlamat').value;
        localStorage.setItem('ppob_config', JSON.stringify(config));
        applyConfig();
        alert("Profil Updated!");
    }

    function applyConfig() {
        document.getElementById('dispNamaBumdes').innerText = config.nama;
        document.getElementById('dispAlamatBumdes').innerText = config.alamat;
        document.getElementById('cfgNama').value = config.nama;
        document.getElementById('cfgAlamat').value = config.alamat;
    }

    function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(dbTransaksi);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        XLSX.writeFile(wb, `Laporan_PPOB.xlsx`);
    }

    function importFromExcel(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (evt) => {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            dbTransaksi = jsonData;
            localStorage.setItem('ppob_data', JSON.stringify(dbTransaksi));
            alert("Berhasil import " + jsonData.length + " data!");
            renderRiwayat();
        };
        reader.readAsArrayBuffer(file);
    }

    function resetData() {
        if(confirm("Hapus semua data transaksi?")) {
            dbTransaksi = [];
            localStorage.setItem('ppob_data', "[]");
            alert("Data dikosongkan.");
            location.reload();
        }
    }

    applyConfig();
</script>
</body>
</html>
